<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>라떼로또 AI 코인 분석기 (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* 타임프레임 버튼 스타일 */
        .tf-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #60a5fa;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen pb-20">

    <div class="fixed inset-0 pointer-events-none bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#0f172a] to-[#0f172a] -z-10"></div>
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-indigo-600/10 blur-[100px] rounded-full pointer-events-none -z-10"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-chart-line text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">라떼로또 코인분석기 <span class="text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded ml-1 align-middle">Pro</span></h1>
                    <p class="text-xs text-slate-500 mt-0.5">7대 기술적 지표 실시간 알고리즘 분석</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                 <div class="hidden md:flex items-center gap-2 bg-slate-800/80 px-4 py-2 rounded-full border border-slate-700">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span id="status-text" class="text-xs font-bold text-slate-400">시스템 연결중...</span>
                </div>
            </div>
        </header>

        <div class="glass-card rounded-2xl p-4 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <select id="coin-select" class="bg-slate-800 border border-slate-600 text-white rounded-xl px-4 py-2.5 font-bold focus:outline-none focus:border-blue-500 transition-colors w-full md:w-64">
                    <option value="KRW-BTC">비트코인 (BTC)</option>
                    <option value="KRW-ETH">이더리움 (ETH)</option>
                    <option value="KRW-XRP">리플 (XRP)</option>
                    <option value="KRW-SOL">솔라나 (SOL)</option>
                    <option value="KRW-DOGE">도지코인 (DOGE)</option>
                    <option value="KRW-AVAX">아발란체 (AVAX)</option>
                    <option value="KRW-ADA">에이다 (ADA)</option>
                    <option value="KRW-SHIB">시바이누 (SHIB)</option>
                </select>
                
                <div class="hidden md:block border-l border-slate-700 pl-4">
                    <span id="display-price" class="text-lg font-bold text-white">0</span>
                    <span class="text-xs text-slate-500">KRW</span>
                    <span id="display-change" class="text-xs font-bold ml-2">0.00%</span>
                </div>
            </div>

            <div class="flex bg-slate-800 p-1 rounded-xl w-full md:w-auto">
                <button class="tf-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-white transition-all" data-tf="15">15분</button>
                <button class="tf-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-white transition-all" data-tf="60">1시간</button>
                <button class="tf-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-white transition-all" data-tf="240">4시간</button>
                <button class="tf-btn flex-1 md:flex-none px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-white transition-all active" data-tf="D">일봉</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-8 space-y-6">
                
                <div class="glass-card rounded-2xl p-1 overflow-hidden h-[500px] relative">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                        <div id="tradingview_chart" style="height:100%;width:100%"></div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wider">Indicator Details</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-800/50">
                                <tr>
                                    <th class="px-4 py-3 rounded-l-lg">지표명</th>
                                    <th class="px-4 py-3">현재 상태값</th>
                                    <th class="px-4 py-3">분석 결과</th>
                                    <th class="px-4 py-3 rounded-r-lg text-right">판단</th>
                                </tr>
                            </thead>
                            <tbody id="indicator-table-body" class="divide-y divide-slate-700/50">
                                <tr><td colspan="4" class="text-center py-4">데이터 분석중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                
                <div class="glass-card rounded-2xl p-8 text-center">
                    <h2 class="text-sm font-bold text-slate-400 mb-2 uppercase">AI 상승 확률 예측</h2>
                    
                    <div class="relative h-56 w-full flex justify-center items-center">
                        <canvas id="probabilityChart"></canvas>
                        <div class="absolute flex flex-col items-center justify-center transform translate-y-2">
                            <span id="prob-percent" class="text-6xl font-bold text-white tracking-tighter drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">--%</span>
                            <span id="prob-label" class="text-sm font-bold mt-2 bg-slate-800 px-3 py-1 rounded-full text-slate-400 border border-slate-700">분석중</span>
                        </div>
                    </div>

                    <p class="text-xs text-slate-500 mt-2 text-center">
                        * 위 확률은 7대 기술적 지표의 가중치 합산 결과이며,<br>100% 미래를 보장하지 않습니다.
                    </p>
                </div>

                <div class="glass-card rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <h3 class="text-blue-400 font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-file-waveform"></i> AI 분석 요약
                    </h3>
                    <div id="ai-summary-text" class="space-y-3 text-sm text-slate-300 leading-relaxed">
                        <div class="animate-pulse flex space-x-4">
                            <div class="flex-1 space-y-4 py-1">
                                <div class="h-4 bg-slate-700 rounded w-3/4"></div>
                                <div class="h-4 bg-slate-700 rounded"></div>
                                <div class="h-4 bg-slate-700 rounded w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-emerald-400 font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chess-board"></i> 추천 전략
                    </h3>
                    <div id="strategy-text" class="text-sm text-slate-300 bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                        데이터 수집 대기중...
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        // === 1. 상태 관리 ===
        const state = {
            market: 'KRW-BTC',  // 업비트 코드
            symbol: 'BTCKRW',   // 트레이딩뷰 코드 (KRW-BTC -> BTCKRW)
            timeframe: 'D',     // 기본 일봉 (15, 60, 240, D)
            candles: [],
            indicators: {},
            scorePercent: 50    // 0~100%
        };

        // === 2. 초기화 ===
        document.addEventListener('DOMContentLoaded', () => {
            initTradingView();
            initTimeframeButtons();
            
            const select = document.getElementById('coin-select');
            
            // 초기 실행
            updateAnalysis();

            // 코인 변경 이벤트
            select.addEventListener('change', (e) => {
                state.market = e.target.value;
                state.symbol = e.target.value.replace('KRW-', '') + 'KRW'; // KRW-BTC -> BTCKRW
                updateAnalysis();
                initTradingView(); // 차트도 변경
            });

            // 1분 자동 갱신
            setInterval(updateAnalysis, 60000);
        });

        function initTimeframeButtons() {
            const btns = document.querySelectorAll('.tf-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // UI 변경
                    btns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // 상태 변경 및 재분석
                    state.timeframe = btn.dataset.tf;
                    updateAnalysis();
                });
            });
        }

        function initTradingView() {
            // 트레이딩뷰 위젯 생성
            new TradingView.widget({
                "autosize": true,
                "symbol": "UPBIT:" + state.symbol,
                "interval": state.timeframe === '60' ? '1H' : state.timeframe === '240' ? '4H' : state.timeframe,
                "timezone": "Asia/Seoul",
                "theme": "dark",
                "style": "1",
                "locale": "kr",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "save_image": false,
                "container_id": "tradingview_chart",
                "backgroundColor": "rgba(15, 23, 42, 1)" // 배경색 일치
            });
        }

        // === 3. 데이터 분석 파이프라인 ===
        async function updateAnalysis() {
            updateStatus('데이터 분석중...', 'yellow');

            try {
                // API 호출 URL 결정 (분봉/일봉)
                let url = '';
                let count = 200;
                
                if (state.timeframe === 'D') {
                    url = `https://api.upbit.com/v1/candles/days?market=${state.market}&count=${count}`;
                } else {
                    url = `https://api.upbit.com/v1/candles/minutes/${state.timeframe}?market=${state.market}&count=${count}`;
                }

                const res = await fetch(url);
                const json = await res.json();
                state.candles = json.reverse(); // 과거 -> 현재 순

                // 가격 표시
                const current = state.candles[state.candles.length-1];
                updatePriceUI(current.trade_price, (current.trade_price - current.opening_price)/current.opening_price*100);

                // 지표 계산
                calculateIndicators();
                
                // 점수 -> 확률 변환
                calculateProbability();

                // UI 렌더링
                renderDashboard();
                updateStatus('실시간 분석 완료', 'green');

            } catch (err) {
                console.error(err);
                updateStatus('데이터 오류', 'red');
            }
        }

        // === 4. 지표 계산 (핵심 알고리즘) ===
        function calculateIndicators() {
            const c = state.candles;
            const closes = c.map(k => k.trade_price);
            const highs = c.map(k => k.high_price);
            const lows = c.map(k => k.low_price);
            const volumes = c.map(k => k.candle_acc_trade_volume);

            state.indicators = {
                rsi: calcRSI(closes, 14),
                bb: calcBB(closes, 20, 2),
                macd: calcMACD(closes, 12, 26, 9),
                ema: { short: calcEMA(closes, 20), long: calcEMA(closes, 60) },
                ichimoku: calcIchimoku(highs, lows, closes),
                volume: calcVolumeProfile(volumes),
                obv: calcOBV(closes, volumes)
            };
        }

        // --- 수학 공식 (이전과 동일하지만 중요함) ---
        function calcRSI(prices, period) {
            let gains = 0, losses = 0;
            for(let i=1; i<=period; i++) {
                let diff = prices[prices.length-i] - prices[prices.length-i-1];
                if(diff >= 0) gains += diff; else losses -= diff;
            }
            return 100 - (100 / (1 + (gains/period)/(losses/period)));
        }
        function calcBB(prices, p, std) {
            const slice = prices.slice(-p);
            const mean = slice.reduce((a,b)=>a+b,0)/p;
            const dev = Math.sqrt(slice.reduce((a,b)=>a+Math.pow(b-mean,2),0)/p);
            return { upper: mean+(dev*std), lower: mean-(dev*std), current: prices[prices.length-1] };
        }
        function calcEMA(prices, p) {
            const k = 2/(p+1);
            let ema = prices[0];
            for(let i=1; i<prices.length; i++) ema = prices[i]*k + ema*(1-k);
            return ema;
        }
        function calcMACD(prices, s, l, sig) {
            const ema12 = calcEMA_Array(prices, 12);
            const ema26 = calcEMA_Array(prices, 26);
            const macdLine = ema12.map((v,i) => v - ema26[i]);
            const signalLine = calcEMA_Array(macdLine, 9); // 약식
            return { hist: macdLine[macdLine.length-1] - signalLine[signalLine.length-1] };
        }
        function calcEMA_Array(arr, p) {
            const k = 2/(p+1);
            let ema = arr[0];
            const res = [ema];
            for(let i=1; i<arr.length; i++) { ema = arr[i]*k + ema*(1-k); res.push(ema); }
            return res;
        }
        function calcIchimoku(highs, lows, closes) {
            const getHL = (p) => (Math.max(...highs.slice(-p)) + Math.min(...lows.slice(-p)))/2;
            const kijun = getHL(26);
            return { price: closes[closes.length-1], kijun, above: closes[closes.length-1] > kijun };
        }
        function calcVolumeProfile(vols) {
            const cur = vols[vols.length-1];
            const avg = vols.slice(-20).reduce((a,b)=>a+b,0)/20;
            return { ratio: cur/avg };
        }
        function calcOBV(closes, vols) {
            let obv = 0; 
            const arr = [0];
            for(let i=1; i<closes.length; i++) {
                if(closes[i]>closes[i-1]) obv += vols[i];
                else if(closes[i]<closes[i-1]) obv -= vols[i];
                arr.push(obv);
            }
            const recent = arr.slice(-5).reduce((a,b)=>a+b,0)/5;
            const past = arr.slice(-10,-5).reduce((a,b)=>a+b,0)/5;
            return { trend: recent > past };
        }

        // === 5. 확률 계산 (Scoring -> Percentage) ===
        function calculateProbability() {
            const i = state.indicators;
            let score = 0;
            // 가중치: 총점 약 14점 만점 기준
            if(i.rsi < 30) score += 2; else if(i.rsi > 70) score -= 2;
            if(i.bb.current < i.bb.lower) score += 2; else if(i.bb.current > i.bb.upper) score -= 2;
            if(i.macd.hist > 0) score += 2; else score -= 2;
            if(i.ema.short > i.ema.long) score += 2; else score -= 2;
            if(i.ichimoku.above) score += 1; else score -= 1;
            if(i.volume.ratio > 1.5) score += 0; // 거래량은 방향성 확인용 (중립)
            if(i.obv.trend) score += 1; else score -= 1;

            // Score(-10 ~ +10) -> Percent(0 ~ 100)
            // 0점일 때 50%, +10점일 때 95%, -10점일 때 5%
            // 공식: 50 + (score * 4.5)
            let percent = 50 + (score * 4.5);
            percent = Math.min(Math.max(percent, 5), 95); // 5%~95% 제한
            state.scorePercent = Math.round(percent);
        }

        // === 6. UI 렌더링 ===
        function renderDashboard() {
            updateGaugeChart(state.scorePercent);
            renderTable();
            renderSummary();
        }

        function renderTable() {
            const i = state.indicators;
            const tbody = document.getElementById('indicator-table-body');
            
            const rows = [
                { name: 'RSI', val: i.rsi.toFixed(2), res: i.rsi>70?'과매수':i.rsi<30?'과매도':'중립', col: i.rsi>70?'red':i.rsi<30?'green':'gray' },
                { name: 'MACD', val: i.macd.hist>0?'양봉':'음봉', res: i.macd.hist>0?'상승 추세':'하락 추세', col: i.macd.hist>0?'green':'red' },
                { name: '볼린저밴드', val: Math.round(i.bb.current).toLocaleString(), res: i.bb.current>i.bb.upper?'상단 돌파':i.bb.current<i.bb.lower?'하단 터치':'밴드 내', col: i.bb.current>i.bb.upper?'red':i.bb.current<i.bb.lower?'green':'gray' },
                { name: '이평선(EMA)', val: i.ema.short>i.ema.long?'정배열':'역배열', res: i.ema.short>i.ema.long?'상승장':'하락장', col: i.ema.short>i.ema.long?'green':'red' },
                { name: '일목균형표', val: i.ichimoku.above?'구름 위':'구름 아래', res: i.ichimoku.above?'매수 우위':'매도 우위', col: i.ichimoku.above?'green':'red' },
                { name: 'OBV', val: i.obv.trend?'상승':'하락', res: i.obv.trend?'매집 중':'이탈 중', col: i.obv.trend?'green':'red' },
                { name: '거래량', val: (i.volume.ratio*100).toFixed(0)+'%', res: i.volume.ratio>1.5?'거래 급증':'평균', col: i.volume.ratio>1.5?'blue':'gray' }
            ];

            tbody.innerHTML = rows.map(r => `
                <tr class="border-b border-slate-700/50 last:border-0 hover:bg-slate-800/30">
                    <td class="px-4 py-3 font-bold text-slate-300">${r.name}</td>
                    <td class="px-4 py-3 font-mono">${r.val}</td>
                    <td class="px-4 py-3">${r.res}</td>
                    <td class="px-4 py-3 text-right">
                        <span class="inline-block w-3 h-3 rounded-full ${r.col === 'green' ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : r.col === 'red' ? 'bg-red-500 shadow-[0_0_10px_#ef4444]' : r.col === 'blue' ? 'bg-blue-500' : 'bg-slate-600'}"></span>
                    </td>
                </tr>
            `).join('');
        }

        function renderSummary() {
            const p = state.scorePercent;
            const box = document.getElementById('ai-summary-text');
            const strat = document.getElementById('strategy-text');
            
            let summary = "";
            let strategy = "";

            if(p >= 80) {
                summary = "<p>1. 모든 지표가 강력한 상승을 가리킵니다.</p><p>2. RSI와 이평선이 완벽한 매수 신호입니다.</p><p>3. 추가 상승 여력이 매우 높습니다.</p>";
                strategy = "적극 매수 구간입니다. 추세가 꺾이기 전까지 홀딩하는 추세 추종 전략을 권장합니다.";
            } else if(p >= 60) {
                summary = "<p>1. 전반적으로 매수 우위 상태입니다.</p><p>2. 하락보다는 상승 확률이 높습니다.</p><p>3. 단기 조정 시 분할 매수가 유효합니다.</p>";
                strategy = "눌림목 매수 전략이 유효합니다. 지지 라인 근처에서 분할로 진입하세요.";
            } else if(p <= 20) {
                summary = "<p>1. 위험 신호가 감지되었습니다.</p><p>2. 모든 지표가 하락을 경고합니다.</p><p>3. 과매도 상태지만 섣부른 진입은 위험합니다.</p>";
                strategy = "절대 진입 금지. 보유자는 손절 라인을 지키고 현금 비중을 100%로 늘리세요.";
            } else if(p <= 40) {
                summary = "<p>1. 매도 압력이 더 강한 상태입니다.</p><p>2. 반등 시마다 매도 물량이 나옵니다.</p><p>3. 추세 반전을 기다려야 합니다.</p>";
                strategy = "보수적 접근 필요. 바닥을 확인하는 패턴(쌍바닥 등)이 나올 때까지 관망하세요.";
            } else {
                summary = "<p>1. 방향성이 없는 횡보장입니다.</p><p>2. 지표들이 엇갈린 신호를 보냅니다.</p><p>3. 거래량이 터지는 쪽으로 방향이 잡힐 것입니다.</p>";
                strategy = "관망이 최선입니다. 박스권 매매 외에는 추세가 결정될 때까지 기다리세요.";
            }
            
            box.innerHTML = summary;
            strat.innerText = strategy;
        }

        // === 차트 및 UI 유틸 ===
        function updateStatus(msg, col) {
            document.getElementById('status-text').innerText = msg;
            document.getElementById('status-dot').className = `w-2 h-2 rounded-full animate-pulse bg-${col}-500`;
        }
        
        function updatePriceUI(price, chg) {
            document.getElementById('display-price').innerText = Math.floor(price).toLocaleString();
            const el = document.getElementById('display-change');
            el.innerText = (chg>0?'+':'') + chg.toFixed(2) + '%';
            el.className = `text-xs font-bold ml-2 ${chg>0?'text-emerald-400':'text-red-400'}`;
        }

        let probChart = null;
        function updateGaugeChart(percent) {
            const ctx = document.getElementById('probabilityChart').getContext('2d');
            const color = percent >= 60 ? '#10b981' : percent <= 40 ? '#ef4444' : '#94a3b8';
            
            document.getElementById('prob-percent').innerText = percent + '%';
            document.getElementById('prob-percent').className = `text-6xl font-bold tracking-tighter drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] ${percent>=60?'text-emerald-400':percent<=40?'text-red-500':'text-slate-300'}`;
            
            document.getElementById('prob-label').innerText = percent>=60?'매수 우위':percent<=40?'매도 우위':'중립/관망';
            document.getElementById('prob-label').className = `text-sm font-bold mt-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 ${percent>=60?'text-emerald-400':percent<=40?'text-red-400':'text-slate-400'}`;

            if(probChart) probChart.destroy();

            probChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percent, 100-percent],
                        backgroundColor: [color, 'rgba(255,255,255,0.05)'],
                        borderWidth: 0,
                        cutout: '85%',
                        circumference: 180,
                        rotation: 270,
                        borderRadius: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { tooltip: { enabled: false } },
                    animation: { animateScale: true }
                }
            });
        }
    </script>
</body>
</html>
